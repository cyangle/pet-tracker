#!/bin/sh

source_dir=$(dirname $0)
cd $source_dir

clean_up() {
  pkill -f /home/debian/app/pet-tracker/bin/pet-tracker
  pkill -f '.vscode-server/extensions/vadimcn.vscode-lldb'
	exit
}

trap clean_up HUP INT TERM

echo "Trying to stop pet-tracker server with debuger from vscode"

pkill -f /home/debian/app/pet-tracker/bin/pet-tracker
pkill -f '.vscode-server/extensions/vadimcn.vscode-lldb'

until ps aux | grep -v "grep --color=auto" | grep /home/debian/app/pet-tracker/bin/pet-tracker > /dev/null 2>&1 ; do
  sleep 1;
  echo "still waiting for previous processes to exit"
done

until ps aux | grep -v "grep --color=auto" | grep .vscode-server/extensions/vadimcn.vscode-lldb > /dev/null 2>&1 ; do
  sleep 1;
  echo "still waiting for previous processes to exit"
done

sleep 2

echo "Stopped pet-tracker server with debuger from vscode"

echo "Starting pet-tracker server with debuger from vscode"
echo 'code --open-url "vscode://vadimcn.vscode-lldb/launch?name=lldb_pet_tracker"' >> ../local/docker_host.pipe

while true; do
    sleep 1
done
